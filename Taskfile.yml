version: 3

dotenv:
  - .env

tasks:
  default:
    cmd: task -l
    silent: true

  setup: &setup
    desc: Set up Canvas LMS
    env:
      COMPOSE_PROJECT_NAME: canvas-lms-{{.DISTRIBUTION}}
      DISTRIBUTION: "{{.DISTRIBUTION}}"
    cmds:
      - cmd: docker compose run --rm web rails db:initial_setup
    requires:
      vars:
        - name: DISTRIBUTION
          enum:
            - alpine
            - debian

  start:
    <<: *setup
    desc: Start Canvas LMS
    vars:
      STORAGE_PATH_PREFIX: '{{.CANVAS_LMS_STORAGE_PATH_PREFIX | default "tmp/files"}}'
    cmds:
      - cmd: docker compose up -d {{.CLI_ARGS}}
      - cmd: >-
          docker compose exec -u root web
          sh -c '[ -d {{.STORAGE_PATH_PREFIX}} ] && chown -R canvas:canvas {{.STORAGE_PATH_PREFIX | splitList "/" | first}} || true'

  stop:
    <<: *setup
    desc: Stop Canvas LMS
    cmds:
      - cmd: docker compose down {{.CLI_ARGS}}

  logs:
    <<: *setup
    desc: Display Docker Compose logs
    cmds:
      - cmd: docker compose logs -f {{.CLI_ARGS}}
